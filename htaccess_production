# Enable rewrite engine
RewriteEngine On
RewriteBase /

# 1. Force HTTPS
RewriteCond %{HTTPS} off
RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]

# 2. Redirect index.php to /
RewriteCond %{THE_REQUEST} \s/index\.php [NC]
RewriteRule ^(.*)index\.php$ /$1 [R=301,L,NE]

# 3. Remove .php extension from client-facing URLs
# Redirect external .php requests to URLs without .php
RewriteCond %{THE_REQUEST} \s/(.+)\.php[\s?] [NC]
RewriteCond %{REQUEST_URI} !^/iconm3/ [NC]
RewriteRule ^ %1 [R=301,L,NE]

# Internally rewrite URLs without .php to .php files
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+)$ $1.php [L]

# 4. Allow static files (css, js, images, etc.)
RewriteCond %{REQUEST_URI} \.(css|js|ico|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)$ [NC]
RewriteRule ^ - [L]

# 5. Allow specific functional files in iconm3 for webhook and AJAX access
RewriteCond %{REQUEST_URI} ^/iconm3/(hitpay_webhook|get_unavailable_slots|get_unavailable_slots_limousine|check_overlap)\.php$ [NC]
RewriteRule ^ - [L]

# 6. Allow admin-facing pages in iconm3
# Rely on PHP session validation
RewriteCond %{REQUEST_URI} ^/iconm3/(admin_login|admin_logout|admin_dashboard|manage_admins|manage_limousines|manage_vehicles|manage_slots)\.php$ [NC]
RewriteRule ^ - [L]

# 7. Prevent access to all other files in the iconm3 folder
RewriteCond %{REQUEST_URI} ^/iconm3/ [NC]
RewriteCond %{REQUEST_URI} !^/iconm3/(hitpay_webhook|get_unavailable_slots|get_unavailable_slots_limousine|check_overlap|admin_login|admin_logout|admin_dashboard|manage_admins|manage_limousines|manage_vehicles|manage_slots)\.php$ [NC]
RewriteRule ^ - [F,L]

# 8. Prevent directory listing
Options -Indexes

# 9. Set PHP session security settings
php_value session.cookie_httponly 1
php_value session.cookie_secure 1
php_value session.cookie_samesite Strict